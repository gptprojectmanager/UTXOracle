# Implementation Plan: Advanced On-Chain Analytics

**Branch**: `009-advanced-onchain-analytics` | **Date**: 2025-12-04 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/009-advanced-onchain-analytics/spec.md`

## Summary

Implement three advanced statistical modules for on-chain analysis: **Power Law Detector** (detects critical regimes via MLE tau estimation), **Symbolic Dynamics Processor** (measures temporal complexity via permutation entropy), and **Fractal Dimension Analyzer** (assesses structural properties via box-counting). These modules integrate into the existing Monte Carlo fusion engine (spec-007) to enhance signal quality with an estimated +40% accuracy improvement.

**Technical Approach**: Pure Python implementations following spec-007 patterns, with optional numpy acceleration. All modules produce votes that feed into enhanced 7-component Monte Carlo fusion.

## Technical Context

**Language/Version**: Python 3.11+ (matching existing scripts/metrics/)
**Primary Dependencies**: None required (pure Python); numpy optional for performance
**Storage**: DuckDB (extend existing `metrics` table from spec-007)
**Testing**: pytest with TDD (Red-Green-Refactor), target ≥85% coverage
**Target Platform**: Linux server (existing UTXOracle infrastructure)
**Project Type**: Single project (extend existing scripts/metrics/ module)
**Performance Goals**: <100ms total for all advanced metrics; <10ms per individual module
**Constraints**: No external dependencies required; backward compatible with spec-007
**Scale/Scope**: Process ~1000 UTXO values per calculation; integrate with daily_analysis.py

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|----------|
| **I. KISS/YAGNI** | ✅ PASS | Pure Python, ~300 LOC total, no new dependencies, extends existing patterns |
| **II. TDD Discipline** | ✅ PASS | Tests defined in spec; TDD workflow enforced; target ≥85% coverage |
| **III. UX Consistency** | ✅ PASS | Extends existing /api/metrics/ endpoint pattern; no new CLI interfaces |
| **IV. Performance** | ✅ PASS | Target <100ms total; individual modules <10ms; no impact on batch processing |
| **V. Privacy & Security** | ✅ PASS | Local processing only; no external API calls; extends existing auth patterns |

**Gate Decision**: ✅ PROCEED - All constitutional principles satisfied

## Project Structure

### Documentation (this feature)

```
specs/009-advanced-onchain-analytics/
├── plan.md              # This file
├── research.md          # Academic references and implementation notes
├── data-model.md        # Pydantic/dataclass models
├── quickstart.md        # Quick start guide (to be created)
├── contracts/           # API interfaces
│   └── advanced_metrics_api.py
└── tasks.md             # Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```
scripts/metrics/                    # Extend existing module
├── __init__.py                     # Add exports for new modules
├── monte_carlo_fusion.py           # MODIFY: Extend for 7 components
├── active_addresses.py             # Existing (spec-007)
├── tx_volume.py                    # Existing (spec-007)
├── power_law.py                    # NEW: Power law detection
├── symbolic_dynamics.py            # NEW: Permutation entropy
└── fractal_dimension.py            # NEW: Box-counting dimension

scripts/models/
└── metrics_models.py               # MODIFY: Add new dataclasses

api/
└── main.py                         # MODIFY: Add /api/metrics/advanced endpoint

tests/
├── test_advanced_metrics.py        # NEW: Unit tests for all 3 modules
└── integration/
    └── test_advanced_integration.py # NEW: Integration tests
```

**Structure Decision**: Extend existing `scripts/metrics/` module following spec-007 patterns. No new directories needed. Three new Python files (~100 LOC each) plus test file.

## Implementation Phases

### Phase 0: Research (COMPLETE)

All research documented in `research.md`:
- ✅ Power Law: Clauset et al. (2009) MLE + KS validation
- ✅ Symbolic Dynamics: Bandt & Pompe (2002) permutation entropy
- ✅ Fractal Dimension: Liebovitch & Toth (1989) box-counting
- ✅ Integration: Weight selection rationale documented

### Phase 1: Design & Contracts (COMPLETE)

All design artifacts created:
- ✅ `data-model.md`: PowerLawResult, SymbolicDynamicsResult, FractalDimensionResult, EnhancedFusionResult
- ✅ `contracts/advanced_metrics_api.py`: Protocol definitions for all modules
- ✅ `research.md`: Academic foundations and implementation algorithms

### Phase 2: Implementation (PENDING - via /speckit.tasks)

Implementation order (KISS - simplest first):
1. **Symbolic Dynamics** (~100 LOC) - Highest ROI, simplest algorithm
2. **Power Law** (~120 LOC) - Well-documented MLE approach
3. **Fractal Dimension** (~80 LOC) - Straightforward box-counting
4. **Enhanced Fusion** (~60 LOC) - Extend existing Monte Carlo

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Performance exceeds 100ms | Low | Medium | Use numpy if available; profile early |
| Power law fit fails on real data | Medium | Low | Graceful degradation (is_valid=False) |
| Integration breaks spec-007 | Low | High | Comprehensive integration tests |
| Symbolic order too high | Low | Low | Auto-reduce order if series too short |

## Dependencies

### Internal (Prerequisites)
- ✅ spec-007 (Monte Carlo Fusion) - COMPLETE
- ⬜ spec-008 (Derivatives) - Optional (funding_vote, oi_vote can be None)

### External (None Required)
- numpy: Optional for performance acceleration
- No new external dependencies

## Success Metrics

| Metric | Target | Validation Method |
|--------|--------|-------------------|
| Power Law τ accuracy | ±0.1 | Synthetic data with known τ |
| Permutation Entropy H | ±0.05 | Analytical solution for monotonic series |
| Fractal Dimension D | ±0.1 | Cantor set (D≈0.63) |
| Total execution time | <100ms | Benchmark on production data |
| Code coverage | ≥85% | pytest --cov |
| Backtest win rate | >spec-007 baseline | 30-day historical comparison |

## Complexity Tracking

*No constitutional violations requiring justification.*

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| (none) | - | - |

---

**Next Step**: Run `/speckit.tasks` to generate implementation task list

**Generated**: 2025-12-04 by /speckit.plan
