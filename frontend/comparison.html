<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTXOracle - Price Comparison Dashboard</title>

    <!-- T073: Plotly.js CDN -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

    <!-- T077: CSS Styling - Black background, orange theme -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a0a0a;
            color: #f0f0f0;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            border-radius: 10px;
            border: 2px solid #ff8c00;
        }

        h1 {
            color: #ff8c00;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #999;
            font-size: 1.1em;
        }

        /* T076: Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #333;
            text-align: center;
            transition: transform 0.2s, border-color 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: #ff8c00;
        }

        .stat-label {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            color: #ff8c00;
            font-size: 2em;
            font-weight: bold;
        }

        .stat-value.positive {
            color: #00ff88;
        }

        .stat-value.negative {
            color: #ff4444;
        }

        /* T075: Chart Container */
        .chart-container {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #333;
            margin-bottom: 40px;
        }

        .chart-title {
            color: #ff8c00;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        #priceChart {
            width: 100%;
            height: 600px;
        }

        /* Loading and Error States */
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.2em;
        }

        .error {
            background: #2a1a1a;
            border: 2px solid #ff4444;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            color: #ff4444;
        }

        /* T074: Timeframe Selector */
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }

        .timeframe-btn {
            background: #2a2a2a;
            color: #f0f0f0;
            border: 2px solid #333;
            padding: 10px 20px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1em;
            transition: all 0.2s;
        }

        .timeframe-btn:hover {
            border-color: #ff8c00;
            background: #333;
        }

        .timeframe-btn.active {
            background: #ff8c00;
            border-color: #ff8c00;
            color: #000;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <header>
        <h1>UTXOracle Price Comparison</h1>
        <div class="subtitle">On-Chain vs Exchange Price Analysis</div>
    </header>

    <!-- T076: Stats Cards -->
    <div class="stats-container" id="statsContainer">
        <div class="stat-card">
            <div class="stat-label">Average Difference</div>
            <div class="stat-value" id="avgDiff">Loading...</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Max Difference</div>
            <div class="stat-value" id="maxDiff">Loading...</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Min Difference</div>
            <div class="stat-value" id="minDiff">Loading...</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg % Difference</div>
            <div class="stat-value" id="avgDiffPercent">Loading...</div>
        </div>
    </div>

    <!-- Timeframe Controls -->
    <div class="controls">
        <button class="timeframe-btn active" onclick="loadData(7, this)">7 Days</button>
        <button class="timeframe-btn" onclick="loadData(30, this)">30 Days</button>
        <button class="timeframe-btn" onclick="loadData(90, this)">90 Days</button>
    </div>

    <!-- T075: Chart -->
    <div class="chart-container">
        <div class="chart-title">Price Comparison Time Series</div>
        <div id="priceChart"></div>
    </div>

    <footer>
        <p>UTXOracle - Bitcoin Exchange-Free Price Discovery</p>
        <p>Spec: 003-mempool-integration-refactor | Phase 4: API & Visualization</p>
    </footer>

    <!-- T074: JavaScript - Fetch data and render chart -->
    <script>
        // API Configuration
        const API_BASE_URL = 'http://localhost:8001';
        let currentDays = 7;

        // T074: Fetch data from API
        async function fetchHistoricalData(days) {
            try {
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                const response = await fetch(`${API_BASE_URL}/api/prices/historical?days=${days}&_=${timestamp}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching historical data:', error);
                throw error;
            }
        }

        async function fetchComparisonStats(days) {
            try {
                // Add timestamp to prevent caching
                const timestamp = new Date().getTime();
                const response = await fetch(`${API_BASE_URL}/api/prices/comparison?days=${days}&_=${timestamp}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching comparison stats:', error);
                throw error;
            }
        }

        // T076: Update stats cards
        function updateStats(stats) {
            document.getElementById('avgDiff').textContent =
                stats.avg_diff !== null ? `$${stats.avg_diff.toFixed(2)}` : 'N/A';
            document.getElementById('maxDiff').textContent =
                stats.max_diff !== null ? `$${stats.max_diff.toFixed(2)}` : 'N/A';
            document.getElementById('minDiff').textContent =
                stats.min_diff !== null ? `$${stats.min_diff.toFixed(2)}` : 'N/A';
            // Show avg % difference from API
            const avgDiffPercentEl = document.getElementById('avgDiffPercent');
            if (stats.avg_diff_percent !== null && stats.avg_diff_percent !== undefined && !isNaN(stats.avg_diff_percent)) {
                avgDiffPercentEl.textContent = `${stats.avg_diff_percent.toFixed(2)}%`;
            } else {
                avgDiffPercentEl.textContent = 'N/A';
            }

            // Color code based on value
            const avgDiffEl = document.getElementById('avgDiff');
            if (stats.avg_diff > 0) {
                avgDiffEl.className = 'stat-value positive';
            } else if (stats.avg_diff < 0) {
                avgDiffEl.className = 'stat-value negative';
            }
        }

        // T075: Render Plotly chart
        function renderChart(data) {
            if (data.length === 0) {
                document.getElementById('priceChart').innerHTML =
                    '<div class="error">No data available yet. Wait for cron to populate data.</div>';
                return;
            }

            // Extract data
            const timestamps = data.map(d => d.timestamp);
            const utxPrices = data.map(d => d.utxoracle_price);
            const memPrices = data.map(d => d.mempool_price);

            // T075: Trace 1 - UTXOracle price (green)
            const traceUTX = {
                x: timestamps,
                y: utxPrices,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'UTXOracle (On-Chain)',
                line: {
                    color: '#00ff88',
                    width: 3
                },
                marker: {
                    size: 6,
                    color: '#00ff88'
                }
            };

            // T075: Trace 2 - Exchange price (red dashed)
            const traceMem = {
                x: timestamps,
                y: memPrices,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Exchange (mempool.space)',
                line: {
                    color: '#ff4444',
                    width: 2,
                    dash: 'dash'
                },
                marker: {
                    size: 4,
                    color: '#ff4444'
                }
            };

            // T075: Layout - Dark theme
            const layout = {
                plot_bgcolor: '#0a0a0a',
                paper_bgcolor: '#0a0a0a',
                font: {
                    color: '#f0f0f0',
                    family: 'Segoe UI, sans-serif'
                },
                xaxis: {
                    title: 'Timestamp',
                    gridcolor: '#333',
                    color: '#999'
                },
                yaxis: {
                    title: 'Price (USD)',
                    gridcolor: '#333',
                    color: '#999',
                    tickformat: '$,.0f'
                },
                hovermode: 'x unified',
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(26, 26, 26, 0.8)',
                    bordercolor: '#ff8c00',
                    borderwidth: 1
                },
                margin: {
                    l: 60,
                    r: 30,
                    t: 30,
                    b: 60
                }
            };

            // T075: Config
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
            };

            // Render
            Plotly.newPlot('priceChart', [traceUTX, traceMem], layout, config);
        }

        // Main data loading function
        async function loadData(days, eventTarget = null) {
            currentDays = days;

            // Update active button (only if called from button click)
            if (eventTarget) {
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                eventTarget.classList.add('active');
            }

            // Show loading
            document.getElementById('priceChart').innerHTML =
                '<div class="loading">Loading data...</div>';

            try {
                // Fetch data in parallel
                const [historicalData, statsData] = await Promise.all([
                    fetchHistoricalData(days),
                    fetchComparisonStats(days)
                ]);

                // Update UI
                updateStats(statsData);
                renderChart(historicalData);

            } catch (error) {
                document.getElementById('priceChart').innerHTML =
                    `<div class="error">Error loading data: ${error.message}</div>`;
                console.error('Load data error:', error);
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadData(7);
        });
    </script>
</body>
</html>
